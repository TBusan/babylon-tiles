# Babylon Tiles é¡¹ç›®æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

Babylon Tiles æ˜¯ä¸€ä¸ªåŸºäº Babylon.js çš„ç“¦ç‰‡åœ°å›¾å’Œåœ°å½¢åŠ è½½ç³»ç»Ÿï¼Œå®Œå…¨æ¨¡ä»¿ three-tile çš„æ¶æ„å’Œå®ç°æ–¹å¼ï¼Œå°† Three.js çš„å®ç°è¿ç§»åˆ° Babylon.jsã€‚

## å®Œæˆçš„åŠŸèƒ½

### âœ… æ ¸å¿ƒåº“ (babylon-tile)

#### 1. ç“¦ç‰‡ç³»ç»Ÿ (tile/)
- **Tile.ts**: å®ç°äº†åŠ¨æ€LODç“¦ç‰‡ç±»
  - å››å‰æ ‘ç»“æ„
  - è§†é”¥ä½“å‰”é™¤
  - è‡ªåŠ¨LODè®¡ç®—
  - ç“¦ç‰‡åŠ è½½å’Œå¸è½½ç®¡ç†

#### 2. åœ°å›¾ç³»ç»Ÿ (map/)
- **TileMap.ts**: ä¸»åœ°å›¾ç±»
  - åœ°å›¾åˆ›å»ºå’Œç®¡ç†
  - åæ ‡è½¬æ¢ï¼ˆåœ°ç†åæ ‡ â†” ä¸–ç•Œåæ ‡ï¼‰
  - æ•°æ®æºç®¡ç†
  - åœ°å›¾æ›´æ–°å¾ªç¯

- **TileMapLoader.ts**: åœ°å›¾æ•°æ®åŠ è½½å™¨
  - ç“¦ç‰‡å‡ ä½•ä½“åŠ è½½
  - ç“¦ç‰‡æè´¨åŠ è½½
  - ä¸‹è½½çº¿ç¨‹ç®¡ç†

- **æŠ•å½±ç³»ç»Ÿ (projection/)**
  - ProjMCT.ts: Webå¢¨å¡æ‰˜æŠ•å½± (EPSG:3857)
  - ProjWGS.ts: WGS84åœ°ç†åæ ‡æŠ•å½± (EPSG:4326)
  - ProjectFactory.ts: æŠ•å½±å·¥å‚

#### 3. å‡ ä½•ä½“ç³»ç»Ÿ (geometry/)
- **TileGeometry.ts**: ç“¦ç‰‡å‡ ä½•ä½“ç±»
  - å°† Three.js çš„ BufferGeometry é€‚é…åˆ° Babylon.js çš„ VertexData
  - DEMæ•°æ®å¤„ç†
  
- **utils.ts**: å‡ ä½•ä½“å·¥å…·å‡½æ•°
  - ä»DEMç”Ÿæˆç½‘æ ¼
  - æ³•å‘é‡è®¡ç®—
  - UVåæ ‡ç”Ÿæˆ

- **skirt.ts**: è£™è¾¹ç”Ÿæˆ
  - é˜²æ­¢ç“¦ç‰‡ç¼éš™
  - è¾¹ç¼˜æ£€æµ‹å’Œå¤„ç†

#### 4. åŠ è½½å™¨ç³»ç»Ÿ (loader/)
- **LoaderFactory.ts**: åŠ è½½å™¨å·¥å‚
  - åŠ è½½å™¨æ³¨å†Œå’Œç®¡ç†
  - æ”¯æŒæ‰©å±•è‡ªå®šä¹‰åŠ è½½å™¨

- **TileImageLoader.ts**: å›¾åƒç“¦ç‰‡åŠ è½½å™¨
  - åŠ è½½PNG/JPGç­‰å›¾åƒç“¦ç‰‡
  - çº¹ç†ç®¡ç†

- **TileGeometryLoader.ts**: å‡ ä½•ä½“åŠ è½½å™¨
  - å¹³é¢å‡ ä½•ä½“ç”Ÿæˆ
  - å¯æ‰©å±•DEMåŠ è½½

- **TileLoadingManager.ts**: åŠ è½½ç®¡ç†å™¨
  - ä¸‹è½½é˜Ÿåˆ—ç®¡ç†
  - åŠ è½½è¿›åº¦è·Ÿè¸ª

#### 5. æ•°æ®æºç³»ç»Ÿ (source/)
- **TileSource.ts**: ç“¦ç‰‡æ•°æ®æºç±»
  - URLæ¨¡æ¿è§£æ
  - ç“¦ç‰‡åæ ‡è®¡ç®—
  - æŠ•å½±æ”¯æŒ

### âœ… æ’ä»¶åº“ (babylon-tile-plugin)

#### 1. BabylonViewer
- å¼€ç®±å³ç”¨çš„3DæŸ¥çœ‹å™¨
- ç›¸æœºæ§åˆ¶
- åœºæ™¯ç®¡ç†
- æ¸²æŸ“å¾ªç¯

#### 2. Map Sources
- arcGisImgSource: ArcGISå½±åƒ
- arcGisDemSource: ArcGISåœ°å½¢
- osmSource: OpenStreetMap
- createMapboxSatellite: Mapboxå«æ˜Ÿå½±åƒ

### âœ… æ¼”ç¤ºåº”ç”¨ (demo)

å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå±•ç¤ºï¼š
- å¦‚ä½•åˆ›å»ºæŸ¥çœ‹å™¨
- å¦‚ä½•åŠ è½½åœ°å›¾
- å¦‚ä½•æ³¨å†ŒåŠ è½½å™¨
- å®æ—¶ä¿¡æ¯æ˜¾ç¤º

## æŠ€æœ¯æ¶æ„å¯¹æ¯”

### Three.js â†’ Babylon.js é€‚é…

| Three.js | Babylon.js | è¯´æ˜ |
|----------|-----------|------|
| Object3D | TransformNode | åœºæ™¯èŠ‚ç‚¹åŸºç±» |
| BufferGeometry | VertexData | å‡ ä½•ä½“æ•°æ® |
| BufferAttribute | Float32Array | é¡¶ç‚¹å±æ€§ |
| Material | StandardMaterial | æè´¨ |
| Mesh | Mesh | ç½‘æ ¼ |
| Vector3 | Vector3 | ä¸‰ç»´å‘é‡ |
| Matrix4 | Matrix | 4x4çŸ©é˜µ |
| Camera | Camera | ç›¸æœº |
| Scene | Scene | åœºæ™¯ |

### åæ ‡ç³»ç»Ÿå·®å¼‚

- **Three.js**: å³æ‰‹åæ ‡ç³»ï¼ŒYè½´å‘ä¸Š
- **Babylon.js**: å·¦æ‰‹åæ ‡ç³»ï¼ŒYè½´å‘ä¸Š

é€‚é…ç­–ç•¥ï¼š
- ä¿æŒ Y è½´å‘ä¸Šä¸å˜
- åœ°å›¾æ—‹è½¬åˆ°XZå¹³é¢ï¼ˆrotation.x = -Math.PI/2ï¼‰
- æŠ•å½±è®¡ç®—ä¿æŒä¸€è‡´

## æ–‡ä»¶ç»“æ„

```
babylon-tiles/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ lib/                      # æ ¸å¿ƒåº“
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ tile/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Tile.ts      # ç“¦ç‰‡ç±» âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ map/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileMap.ts           # åœ°å›¾ç±» âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileMapLoader.ts     # åœ°å›¾åŠ è½½å™¨ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ projection/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IProjection.ts   # æŠ•å½±æ¥å£ âœ…
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProjMCT.ts       # å¢¨å¡æ‰˜æŠ•å½± âœ…
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProjWGS.ts       # WGS84æŠ•å½± âœ…
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BaseProjection.ts âœ…
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProjectFactory.ts âœ…
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ geometry/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileGeometry.ts      # ç“¦ç‰‡å‡ ä½•ä½“ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GeometryDataTypes.ts  âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ utils.ts             # å·¥å…·å‡½æ•° âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ skirt.ts             # è£™è¾¹ç”Ÿæˆ âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ loader/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ITileLoaders.ts      # åŠ è½½å™¨æ¥å£ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoaderFactory.ts     # åŠ è½½å™¨å·¥å‚ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileLoader.ts        # åŸºç¡€åŠ è½½å™¨ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileImageLoader.ts   # å›¾åƒåŠ è½½å™¨ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileGeometryLoader.ts âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileLoadingManager.ts âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ source/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ISource.ts           # æ•°æ®æºæ¥å£ âœ…
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TileSource.ts        # æ•°æ®æºå®ç° âœ…
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                 # ä¸»å…¥å£ âœ…
â”‚   â”‚   â”œâ”€â”€ package.json                 âœ…
â”‚   â”‚   â”œâ”€â”€ tsconfig.json                âœ…
â”‚   â”‚   â”œâ”€â”€ vite.config.ts               âœ…
â”‚   â”‚   â””â”€â”€ README.md                    âœ…
â”‚   â”œâ”€â”€ plugin/                  # æ’ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ BabylonViewer.ts        # æŸ¥çœ‹å™¨ âœ…
â”‚   â”‚   â”‚   â”œâ”€â”€ mapSource/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts            # æ•°æ®æº âœ…
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                âœ…
â”‚   â”‚   â”œâ”€â”€ package.json                âœ…
â”‚   â”‚   â”œâ”€â”€ tsconfig.json               âœ…
â”‚   â”‚   â”œâ”€â”€ vite.config.ts              âœ…
â”‚   â”‚   â””â”€â”€ README.md                   âœ…
â”‚   â””â”€â”€ demo/                    # æ¼”ç¤ºåº”ç”¨
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â””â”€â”€ main.ts                 # ä¸»ç¨‹åº âœ…
â”‚       â”œâ”€â”€ index.html                  âœ…
â”‚       â”œâ”€â”€ package.json                âœ…
â”‚       â”œâ”€â”€ tsconfig.json               âœ…
â”‚       â””â”€â”€ vite.config.ts              âœ…
â”œâ”€â”€ package.json                        âœ…
â”œâ”€â”€ pnpm-workspace.yaml                 âœ…
â”œâ”€â”€ README.md                           âœ…
â”œâ”€â”€ USAGE.md                            âœ…
â”œâ”€â”€ GETTING_STARTED.md                  âœ…
â”œâ”€â”€ PROJECT_SUMMARY.md                  âœ…
â””â”€â”€ .gitignore                          âœ…
```

## å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

1. âœ… åŠ¨æ€LODç“¦ç‰‡ç³»ç»Ÿ
2. âœ… åœ°å›¾æŠ•å½±ï¼ˆWeb Mercator, WGS84ï¼‰
3. âœ… å›¾åƒç“¦ç‰‡åŠ è½½
4. âœ… å¹³é¢å‡ ä½•ä½“ç”Ÿæˆ
5. âœ… åŠ è½½å™¨æ‰©å±•ç³»ç»Ÿ
6. âœ… åæ ‡è½¬æ¢
7. âœ… è§†é”¥ä½“å‰”é™¤
8. âœ… ç“¦ç‰‡ç¼“å­˜ç®¡ç†
9. âœ… å¤šæ•°æ®æºæ”¯æŒ
10. âœ… å®Œæ•´ç¤ºä¾‹åº”ç”¨

## å¾…æ‰©å±•åŠŸèƒ½

1. ğŸš§ Martiniåœ°å½¢ç½‘æ ¼ç”Ÿæˆç®—æ³•
2. ğŸš§ terrainRGB DEMåŠ è½½å™¨
3. ğŸš§ LERCåœ°å½¢åŠ è½½å™¨
4. ğŸš§ Mapbox Terrainç“¦ç‰‡æ”¯æŒ
5. ğŸš§ çŸ¢é‡ç“¦ç‰‡(MVT)æ”¯æŒ
6. ğŸš§ GeoJSONåŠ è½½å™¨
7. ğŸš§ ç½—ç›˜æ§ä»¶
8. ğŸš§ æµ‹é‡å·¥å…·
9. ğŸš§ IndexedDBç¼“å­˜
10. ğŸš§ æ€§èƒ½ç»Ÿè®¡é¢æ¿

## ä½¿ç”¨æ–¹å¼

### å®‰è£…ä¾èµ–
```bash
pnpm install
```

### æ„å»ºé¡¹ç›®
```bash
pnpm build
```

### è¿è¡Œæ¼”ç¤º
```bash
pnpm dev
```

## å…³é”®å®ç°ç»†èŠ‚

### 1. LODç³»ç»Ÿ

é‡‡ç”¨è·ç¦»æ¯”ä¾‹ç®—æ³•ï¼š
```typescript
distRatio = distance / tileSize
```
- è·ç¦»æ¯”ä¾‹å°äºé˜ˆå€¼æ—¶ç»†åˆ†ç“¦ç‰‡
- è·ç¦»æ¯”ä¾‹å¤§äºé˜ˆå€¼æ—¶åˆå¹¶ç“¦ç‰‡

### 2. åæ ‡è½¬æ¢

åœ°ç†åæ ‡ â†’ æŠ•å½±åæ ‡ â†’ åœ°å›¾åæ ‡ â†’ ä¸–ç•Œåæ ‡

```typescript
geo2world(geo: Vector3) {
  const projected = this.projection.project(geo.x, geo.y);
  const mapPos = new Vector3(projected.x, projected.y, geo.z);
  return Vector3.TransformCoordinates(mapPos, this.getWorldMatrix());
}
```

### 3. ç“¦ç‰‡URLç”Ÿæˆ

æ”¯æŒå¤šç§URLæ¨¡æ¿æ ¼å¼ï¼š
- `{z}/{x}/{y}`: æ ‡å‡†XYZæ ¼å¼
- `{s}`: å­åŸŸå
- TMSæ–¹æ¡ˆæ”¯æŒ

### 4. è£™è¾¹ç”Ÿæˆ

è§£å†³ç“¦ç‰‡æ¥ç¼é—®é¢˜ï¼š
- æ£€æµ‹è¾¹ç¼˜é¡¶ç‚¹
- ç”Ÿæˆå‘ä¸‹å»¶ä¼¸çš„è£™è¾¹
- è‡ªåŠ¨ä¸‰è§’åŒ–

## æ€§èƒ½ä¼˜åŒ–

1. **è§†é”¥ä½“å‰”é™¤**: åªæ¸²æŸ“å¯è§ç“¦ç‰‡
2. **LODæ§åˆ¶**: æ ¹æ®è·ç¦»åŠ¨æ€è°ƒæ•´ç»†èŠ‚
3. **ä¸‹è½½é™åˆ¶**: é™åˆ¶å¹¶å‘ä¸‹è½½æ•°é‡
4. **èµ„æºé‡Šæ”¾**: åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„ç“¦ç‰‡
5. **æ›´æ–°èŠ‚æµ**: æ§åˆ¶ç“¦ç‰‡æ ‘æ›´æ–°é¢‘ç‡

## ä¸ three-tile çš„å…¼å®¹æ€§

æ ¸å¿ƒAPIåŸºæœ¬ä¿æŒä¸€è‡´ï¼š
- ç±»åç›¸åŒ
- æ–¹æ³•ç­¾åç›¸ä¼¼
- é…ç½®å‚æ•°å…¼å®¹
- æ‰©å±•æ–¹å¼ä¸€è‡´

ä¸»è¦å·®å¼‚åœ¨äºåº•å±‚3Då¼•æ“çš„ä¸åŒã€‚

## æ€»ç»“

Babylon Tiles æˆåŠŸå°† three-tile çš„æ ¸å¿ƒåŠŸèƒ½è¿ç§»åˆ° Babylon.jsï¼Œæä¾›äº†ï¼š

1. âœ… å®Œæ•´çš„ç“¦ç‰‡åœ°å›¾ç³»ç»Ÿ
2. âœ… çµæ´»çš„åŠ è½½å™¨æ¶æ„
3. âœ… å¤šæŠ•å½±æ”¯æŒ
4. âœ… æ˜“äºæ‰©å±•çš„æ’ä»¶ç³»ç»Ÿ
5. âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹

é¡¹ç›®é‡‡ç”¨ monorepo ç»“æ„ï¼Œä½¿ç”¨ pnpm workspace ç®¡ç†ï¼Œæ–¹ä¾¿å¼€å‘å’Œç»´æŠ¤ã€‚

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²ç»å®ç°å¹¶å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œå¯ä»¥ä½œä¸ºåŸºç¡€è¿›è¡Œè¿›ä¸€æ­¥æ‰©å±•å’Œä¼˜åŒ–ã€‚

